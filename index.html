<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nearest Station</title>
  <style>
    :root{
      --bg:#fff; --card:#fafafa; --fg:#111; --muted:#666; --accent:#2f63ff;
      --radius:14px; --gap:12px;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;background:var(--bg);color:var(--fg);display:flex;align-items:center;justify-content:center}
    #wrap{
      width:96%;
      max-width:760px;
      padding:20px;
      border-radius:var(--radius);
      text-align:center;
      border:1px solid #eee;
      background:var(--card);
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }
    #station{font-size:2.0rem;font-weight:800;line-height:1.05;text-align:center;word-break:break-word;margin:0;padding:0 6px}
    #distance{margin-top:6px;font-size:1.05rem;color:var(--muted);text-align:center}
    #note{margin-top:8px;font-size:0.95rem;color:var(--muted);text-align:center}
    button{margin-top:12px;padding:12px 18px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:700;font-size:1rem;width:100%;max-width:260px}
    hr.sep{width:100%;margin:12px 0;border:none;border-top:1px solid #eee}
    /* Editor inputs */
    .editor-input{width:64%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-right:8px;box-sizing:border-box}
    .editor-row{width:100%;display:flex;justify-content:center;gap:8px;align-items:center}
    .small-btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    #editor{width:100%;max-width:760px;margin:0 auto;text-align:center}
    #searchResults{margin-top:12px;text-align:left}
    .candidate{display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px solid #eee;border-radius:8px}
    .candidate button{padding:6px 10px;border-radius:6px;background:#0b7cff;color:#fff;border:0}
    #editorPreview{margin-top:12px;display:none;text-align:center}
    #previewName{font-weight:700;font-size:1.1rem}
    #previewCoord{color:#666;margin-top:6px}
    #githubArea{margin-top:8px;display:none}
    #editorMsg{margin-top:8px;color:#b91c1c}
    @media (max-width:420px){
      :root{font-size:17px}
      #wrap{padding:18px;max-width:100%;width:100%}
      #station{font-size:2.2rem}
      #distance{font-size:1.15rem}
      button{max-width:100%;width:100%}
      .editor-input{width:58%}
      .editor-row{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div id="wrap" role="main" aria-live="polite">
    <div id="station">最寄り駅: 読み込み中…</div>
    <div id="distance" aria-hidden="true"></div>
    <div id="note">stations.js を同フォルダに置いてください。自動で取得・再試行します。</div>
    <button id="retry" aria-label="再読み込みして最寄り駅を判定">再読み込みして判定</button>

    <hr class="sep">

    <div id="editor" aria-label="駅編集">
      <div class="editor-row">
        <input id="editName" class="editor-input" placeholder="駅名を入力（例：八丁畷）" />
        <button id="btnSearch" class="small-btn" style="background:#0b7cff;color:#fff">検索</button>
      </div>

      <div id="searchResults"></div>

      <div id="editorPreview">
        <div id="previewName"></div>
        <div id="previewCoord"></div>
        <div style="margin-top:8px">
          <button id="confirmYes" class="small-btn" style="background:#16a34a;color:#fff;margin-right:8px">はい</button>
          <button id="confirmNo" class="small-btn" style="background:#e5e7eb;color:#111;margin-right:8px">いいえ</button>
          <button id="confirmRetry" class="small-btn" style="background:#f59e0b;color:#fff">再検索</button>
        </div>
        <div style="margin-top:10px">
          <button id="downloadStations" class="small-btn" style="background:#2563eb;color:#fff">stations.js をダウンロード</button>
          <button id="downloadUser" class="small-btn" style="background:#6b7280;color:#fff;margin-left:8px">ユーザーデータをダウンロード</button>
          <button id="importBtn" class="small-btn" style="background:#111827;color:#fff;margin-left:8px">インポート</button>
        </div>

        <div id="githubArea">
          <input id="ghToken" placeholder="GitHub Personal Access Token" style="width:60%;padding:8px;border-radius:6px;border:1px solid #ddd" />
          <input id="ghRepo" placeholder="owner/repo (例: user/repo)" style="width:34%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-left:6px" />
          <div style="font-size:12px;color:#888;margin-top:6px">コミット先はルートの <code>stations.js</code> を上書きします</div>
          <div style="margin-top:8px">
            <button id="commitGitHub" class="small-btn" style="background:#111827;color:#fff">GitHub にコミット</button>
          </div>
        </div>

        <div id="editorMsg"></div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      /* --- 基本ユーティリティ --- */
      function toRad(d){ return d * Math.PI / 180; }
      function hav(lat1, lon1, lat2, lon2){
        const R = 6371000;
        const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      const elStation = document.getElementById('station');
      const elDistance = document.getElementById('distance');
      const elNote = document.getElementById('note');
      const btn = document.getElementById('retry');

      /* --- stations.js の安全取得と評価 --- */
      async function fetchAndEvalStations(token){
        const url = 'stations.js' + (token ? ('?v=' + encodeURIComponent(token)) : '');
        const res = await fetch(url, {cache: 'no-store'});
        if(!res.ok) throw new Error('stations.js の取得に失敗: ' + res.status);
        const text = await res.text();
        try {
          const fn = new Function('window', text + '\nreturn typeof window.stations !== "undefined" ? window.stations : null;');
          return fn(window);
        } catch(e){
          throw new Error('stations.js の評価に失敗: ' + e.message);
        }
      }

      function showNearestByCoords(lat, lon){
        if(!window.stations || !Array.isArray(window.stations) || window.stations.length === 0){
          elStation.textContent = 'データが見つかりません';
          elDistance.textContent = '';
          return;
        }
        const curLat = Number(lat), curLon = Number(lon);
        let best = null;
        for(const s of window.stations){
          const sLat = Number(s.lat), sLon = Number(s.lon);
          if(!isFinite(sLat) || !isFinite(sLon)) continue;
          const d = hav(curLat, curLon, sLat, sLon);
          if(!best || d < best.d) best = { name: s.name, d: Math.round(d) };
        }
        if(best){
          elStation.textContent = best.name;
          elDistance.textContent = `約 ${best.d} m`;
        } else {
          elStation.textContent = '最寄り判定に失敗しました';
          elDistance.textContent = '';
        }
      }

      /* --- 自動起動と再読み込み --- */
      let inProgress = false;
      async function runOnce(force){
        if(inProgress) return;
        inProgress = true;
        elStation.textContent = 'データを取得中…';
        elDistance.textContent = '';
        let loaded = false;
        for(let i=0;i<3;i++){
          try {
            const token = force ? Date.now() : (i === 0 ? '' : Date.now());
            const s = await fetchAndEvalStations(token);
            if(s && Array.isArray(s) && s.length > 0){ loaded = true; break; }
          } catch(e){
            elNote.textContent = '読み込み試行中: ' + e.message;
          }
          await new Promise(r => setTimeout(r, 300));
        }

        if(!loaded){
          elStation.textContent = 'stations.js が読み込めません';
          elDistance.textContent = '';
          elNote.textContent = 'stations.js を同フォルダに配置し、ファイル名が小文字 exactly stations.js であることを確認してください。';
          inProgress = false;
          return;
        }

        // userDB を適用してから位置取得
        applyUserDBToStations();

        if(navigator.geolocation){
          elStation.textContent = '現在地を取得中…';
          navigator.geolocation.getCurrentPosition(p=>{
            showNearestByCoords(p.coords.latitude, p.coords.longitude);
            elNote.textContent = '';
            inProgress = false;
          }, err=>{
            elStation.textContent = '位置情報が取得できません';
            elDistance.textContent = '';
            elNote.textContent = '端末の位置情報許可を確認してください。手動テストは URL に ?lat=35.52231&lon=139.69254 を付けてください。';
            inProgress = false;
          }, { enableHighAccuracy: true, maximumAge:0, timeout:10000 });
        } else {
          elStation.textContent = '位置情報未対応';
          elDistance.textContent = '';
          const p = new URLSearchParams(location.search);
          const qlat = p.get('lat'), qlon = p.get('lon');
          if(qlat && qlon){ showNearestByCoords(Number(qlat), Number(qlon)); elNote.textContent = ''; }
          else { elNote.textContent = '手動で試すには URL に ?lat=緯度&lon=経度 を付けてください。'; }
          inProgress = false;
        }
      }

      btn.addEventListener('click', ()=>{ runOnce(true); });

      /* --- ユーザーデータ(localStorage) 管理 --- */
      const USER_DB_KEY = 'stations_user_db_v1';
      function loadUserDB(){
        try{
          const txt = localStorage.getItem(USER_DB_KEY);
          if(!txt) return { updated: {}, added: [] };
          return JSON.parse(txt);
        }catch(e){
          return { updated: {}, added: [] };
        }
      }
      function saveUserDB(db){
        db = db || { updated:{}, added:[] };
        db._updated_at = Date.now();
        localStorage.setItem(USER_DB_KEY, JSON.stringify(db));
      }

      function applyUserDBToStations(){
        const user = loadUserDB();
        if(!window.stations || !Array.isArray(window.stations)) window.stations = [];
        // 名前->index map
        const nameToIndex = new Map();
        window.stations.forEach((s,i)=>{ if(s && s.name) nameToIndex.set(String(s.name), i); });

        // updated 上書きまたは追加
        for(const [name, coord] of Object.entries(user.updated || {})){
          if(nameToIndex.has(name)){
            const idx = nameToIndex.get(name);
            window.stations[idx] = { name: name, lat: Number(coord.lat), lon: Number(coord.lon) };
          } else {
            window.stations.push({ name: name, lat: Number(coord.lat), lon: Number(coord.lon) });
            nameToIndex.set(name, window.stations.length - 1);
          }
        }
        // added 末尾追加（重複回避）
        (user.added || []).forEach(a=>{
          if(!nameToIndex.has(a.name)){
            window.stations.push({ name: a.name, lat: Number(a.lat), lon: Number(a.lon) });
            nameToIndex.set(a.name, window.stations.length - 1);
          }
        });
      }

      function saveUserEdit({ name, lat, lon, mode }){
        const db = loadUserDB();
        const ts = Date.now();
        if(mode === 'update'){
          db.updated = db.updated || {};
          db.updated[name] = { lat: Number(lat), lon: Number(lon), ts };
        } else {
          db.added = db.added || [];
          if(db.updated && db.updated[name]){
            db.updated[name] = { lat:Number(lat), lon:Number(lon), ts };
          } else {
            const exists = db.added.find(a => a.name === name);
            if(exists){ exists.lat = Number(lat); exists.lon = Number(lon); exists.ts = ts; }
            else db.added.push({ name, lat:Number(lat), lon:Number(lon), ts });
          }
        }
        saveUserDB(db);
        applyUserDBToStations();
        elNote.textContent = 'ユーザーデータを保存しました';
        // 再判定
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(p=>{ showNearestByCoords(p.coords.latitude, p.coords.longitude); }, ()=>{});
        }
      }

      function downloadUserStationsFile(){
        const db = loadUserDB();
        const orig = Array.isArray(window.stations) ? JSON.parse(JSON.stringify(window.stations)) : [];
        const merged = (function(){
          const map = new Map();
          orig.forEach(s => map.set(s.name, { name: s.name, lat: s.lat, lon: s.lon }));
          Object.entries(db.updated || {}).forEach(([name, c]) => map.set(name, { name, lat: c.lat, lon: c.lon }));
          (db.added || []).forEach(a => { if(!map.has(a.name)) map.set(a.name, { name: a.name, lat: a.lat, lon: a.lon }); });
          return Array.from(map.values());
        })();
        const js = 'window.stations = ' + JSON.stringify(merged, null, 2) + ';\n';
        const blob = new Blob([js], { type: 'application/javascript;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'stations_user.js';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function importUserDBFromJSON(jsonText){
        try{
          const parsed = JSON.parse(jsonText);
          if(parsed && (parsed.updated || parsed.added)){
            saveUserDB(parsed);
            applyUserDBToStations();
            elNote.textContent = 'ユーザーデータをインポートしました';
            return true;
          }
          if(Array.isArray(parsed)){
            const db = loadUserDB();
            db.added = db.added || [];
            parsed.forEach(s=>{
              if(s && s.name && isFinite(Number(s.lat)) && isFinite(Number(s.lon))){
                const exists = db.added.find(a=>a.name===s.name);
                if(exists){ exists.lat = s.lat; exists.lon = s.lon; exists.ts = Date.now(); }
                else db.added.push({ name:s.name, lat:s.lat, lon:s.lon, ts: Date.now() });
              }
            });
            saveUserDB(db);
            applyUserDBToStations();
            elNote.textContent = 'stations 配列をインポートしました';
            return true;
          }
        }catch(e){
          return false;
        }
        return false;
      }

      /* --- 検索 UI と Wikipedia 連携 --- */
      const $ = sel => document.querySelector(sel);
      const btnSearch = $('#btnSearch');
      const editName = $('#editName');
      const searchResults = $('#searchResults');
      const editorPreview = $('#editorPreview');
      const previewName = $('#previewName');
      const previewCoord = $('#previewCoord');
      const confirmYes = $('#confirmYes');
      const confirmNo = $('#confirmNo');
      const confirmRetry = $('#confirmRetry');
      const downloadStations = $('#downloadStations');
      const downloadUser = $('#downloadUser');
      const importBtn = $('#importBtn');
      const commitGitHub = $('#commitGitHub');
      const ghArea = $('#githubArea');
      const ghToken = $('#ghToken');
      const ghRepo = $('#ghRepo');
      const editorMsg = $('#editorMsg');

      let currentCandidates = []; // {title, lat, lon, pageid}
      let selectedCandidate = null;

      async function wikiSearch(name){
        editorMsg.textContent = '';
        searchResults.innerHTML = '検索中…';
        currentCandidates = []; selectedCandidate = null;
        try{
          const urlSearch = 'https://ja.wikipedia.org/w/api.php?origin=*&action=query&list=search&srprop=&format=json&srsearch=' + encodeURIComponent(name);
          const r1 = await fetch(urlSearch);
          const j1 = await r1.json();
          const hits = (j1.query && j1.query.search) ? j1.query.search.slice(0,8) : [];
          if(hits.length === 0){ searchResults.innerHTML = '候補が見つかりませんでした'; return; }

          const titles = hits.map(h=>h.title).join('|');
          const urlCoords = 'https://ja.wikipedia.org/w/api.php?origin=*&action=query&prop=coordinates&format=json&titles=' + encodeURIComponent(titles);
          const r2 = await fetch(urlCoords);
          const j2 = await r2.json();
          const pages = j2.query && j2.query.pages ? j2.query.pages : {};
          const list = hits.map(h=>{
            const p = Object.values(pages).find(pg => pg.title === h.title) || {};
            const coord = (p.coordinates && p.coordinates[0]) ? p.coordinates[0] : null;
            return { title: h.title, pageid: p.pageid || null, lat: coord ? coord.lat : null, lon: coord ? coord.lon : null };
          });

          currentCandidates = list;
          renderCandidates();
        }catch(e){
          searchResults.innerHTML = '検索エラー: ' + e.message;
        }
      }

      function renderCandidates(){
        if(!currentCandidates || currentCandidates.length===0){ searchResults.innerHTML='候補がありません'; return; }
        searchResults.innerHTML = '';
        const container = document.createElement('div');
        container.style.display='flex'; container.style.flexDirection='column'; container.style.gap='8px';
        currentCandidates.forEach((c, idx)=>{
          const row = document.createElement('div');
          row.className = 'candidate';
          const left = document.createElement('div');
          left.textContent = c.title + (c.lat ? `（座標あり）` : `（座標なし）`);
          const right = document.createElement('div');
          const btn = document.createElement('button');
          btn.textContent = '選択';
          btn.addEventListener('click', ()=>{ selectCandidate(idx); });
          right.appendChild(btn);
          row.appendChild(left); row.appendChild(right);
          container.appendChild(row);
        });
        searchResults.appendChild(container);
      }

      async function selectCandidate(idx){
        const c = currentCandidates[idx];
        selectedCandidate = c;
        editorMsg.textContent = '';
        // 座標がない場合は本文抽出で緯度経度を試行
        if(!c.lat){
          editorMsg.textContent = '座標がページにないため本文を解析します…';
          try{
            const urlParse = 'https://ja.wikipedia.org/w/api.php?origin=*&action=query&prop=revisions&rvprop=content&format=json&titles=' + encodeURIComponent(c.title);
            const r = await fetch(urlParse);
            const j = await r.json();
            const page = Object.values(j.query.pages)[0];
            const content = page.revisions && page.revisions[0] ? (page.revisions[0]['*'] || '') : '';
            // 簡易パターン検索: geo|coord|latitude|longitude の数値を抜く
            const m = content.match(/(?:coord|latitude|longitude|coord=|lat=|lon=)[^0-9+-]*([0-9.+-]{2,})[^0-9.+-]*([0-9.+-]{2,})/i);
            if(m && m[1] && m[2]){
              c.lat = parseFloat(m[1]);
              c.lon = parseFloat(m[2]);
            } else {
              // infobox の {{coord|lat|lon}} パターン
              const m2 = content.match(/\{\{\s*coord\s*\|\s*([0-9.+-]+)\s*\|\s*([0-9.+-]+)\s*/i);
              if(m2 && m2[1] && m2[2]){ c.lat = parseFloat(m2[1]); c.lon = parseFloat(m2[2]); }
            }
          }catch(e){
            editorMsg.textContent = '本文解析でエラー: ' + e.message;
          }
        }
        // プレビュー表示
        editorPreview.style.display = 'block';
        previewName.textContent = c.title;
        previewCoord.textContent = (isFinite(Number(c.lat)) && isFinite(Number(c.lon))) ? `緯度: ${c.lat}  経度: ${c.lon}` : '座標が見つかりません';
      }

      // confirm ハンドラ
      confirmYes.addEventListener('click', ()=>{
        if(!selectedCandidate){ editorMsg.textContent = '候補を選択してください'; return; }
        const name = selectedCandidate.title;
        const lat = selectedCandidate.lat;
        const lon = selectedCandidate.lon;
        if(!isFinite(Number(lat)) || !isFinite(Number(lon))){
          editorMsg.textContent = '座標が無いため保存できません';
          return;
        }
        const mode = (window.stations && window.stations.some(s=>s.name === name)) ? 'update' : 'add';
        saveUserEdit({ name, lat, lon, mode });
        editorMsg.textContent = '保存しました';
        editorPreview.style.display = 'none';
        searchResults.innerHTML = '';
      });

      confirmNo.addEventListener('click', ()=>{
        editorPreview.style.display = 'none';
        editorMsg.textContent = 'キャンセルしました';
      });

      confirmRetry.addEventListener('click', ()=>{
        if(editName && editName.value) wikiSearch(editName.value);
      });

      btnSearch.addEventListener('click', ()=>{
        const v = editName.value && editName.value.trim();
        if(!v){ searchResults.innerHTML = '駅名を入力してください'; return; }
        wikiSearch(v);
      });

      downloadStations.addEventListener('click', ()=>{
        // 現在の merged をダウンロードして stations.js として保存
        downloadUserStationsFile();
      });

      downloadUser.addEventListener('click', ()=>{
        // ユーザーデータ（JSON）をダウンロード
        const db = loadUserDB();
        const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'stations_user_db.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      importBtn.addEventListener('click', async ()=>{
        const txt = prompt('JSON を貼ってください（stations 配列または {updated,added} 形式）');
        if(!txt) return;
        const ok = importUserDBFromJSON(txt);
        if(!ok) editorMsg.textContent = 'インポートに失敗しました';
        else editorMsg.textContent = 'インポートに成功しました';
      });

      // GitHub コミットは任意で有効化。UIは用意済みだが使用時はトークンを入力すること。
      commitGitHub.addEventListener('click', async ()=>{
        const token = ghToken.value && ghToken.value.trim();
        const repo = ghRepo.value && ghRepo.value.trim();
        if(!token || !repo){ editorMsg.textContent = 'トークンと owner/repo を入力してください'; return; }
        editorMsg.textContent = 'GitHub にコミット中...';
        try{
          // 簡易: create/update file via GitHub REST API v3
          const path = 'stations.js';
          // 1) get SHA if exists
          const getUrl = `https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}`;
          let sha = null;
          let message = 'Update stations.js via web editor';
          try{
            const r = await fetch(getUrl, { headers: { Authorization: 'token ' + token, Accept: 'application/vnd.github.v3+json' }});
            if(r.ok){ const j = await r.json(); sha = j.sha; }
          }catch(e){}
          // prepare content
          const db = loadUserDB();
          const orig = Array.isArray(window.stations) ? JSON.parse(JSON.stringify(window.stations)) : [];
          const merged = (function(){
            const map = new Map();
            orig.forEach(s => map.set(s.name, { name: s.name, lat: s.lat, lon: s.lon }));
            Object.entries(db.updated || {}).forEach(([name, c]) => map.set(name, { name, lat: c.lat, lon: c.lon }));
            (db.added || []).forEach(a => { if(!map.has(a.name)) map.set(a.name, { name: a.name, lat: a.lat, lon: a.lon }); });
            return Array.from(map.values());
          })();
          const content = 'window.stations = ' + JSON.stringify(merged, null, 2) + ';\n';
          const body = {
            message,
            content: btoa(unescape(encodeURIComponent(content))),
            committer: { name: "Web Editor", email: "noreply@example.com" }
          };
          if(sha) body.sha = sha;
          const putRes = await fetch(getUrl, { method: 'PUT', headers: { Authorization: 'token ' + token, Accept: 'application/vnd.github.v3+json' }, body: JSON.stringify(body) });
          if(!putRes.ok){ const er = await putRes.text(); throw new Error('GitHub API error: ' + putRes.status + ' ' + er); }
          editorMsg.textContent = 'GitHub にコミットしました';
        }catch(e){
          editorMsg.textContent = 'コミット失敗: ' + e.message;
        }
      });

      /* --- 初回適用と公開 API --- */
      window.userStations = {
        loadUserDB, saveUserDB, applyUserDBToStations, saveUserEdit, downloadUserStationsFile, importUserDBFromJSON
      };

      try{ applyUserDBToStations(); }catch(e){}
      runOnce(false);
      window._showNearest = function(lat,lon){ showNearestByCoords(lat,lon); };
    })();
  </script>
</body>
</html>
