<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nearest Station</title>
  <style>
    :root{
      --bg:#fff; --card:#fafafa; --fg:#111; --muted:#666; --accent:#2f63ff;
      --radius:14px; --gap:16px;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;background:var(--bg);color:var(--fg);display:flex;align-items:center;justify-content:center}
    /* 横長化: 幅を広げ、左右余白を減らす */
    #wrap{
      width:98%;
      max-width:900px;      /* 横を広く確保 */
      padding:20px;
      border-radius:var(--radius);
      text-align:left;
      border:1px solid #eee;
      background:var(--card);
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* 駅名と距離を同一行にして段ずれ防止 */
    #topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      width:100%;
      flex-wrap:nowrap;
    }
    #station{
      font-size:1.5rem; /* 約24px */
      font-weight:700;
      line-height:1.15;
      white-space:nowrap;       /* 改行させない */
      overflow:hidden;
      text-overflow:ellipsis;   /* 長い駅名は省略「…」にする */
      max-width: calc(100% - 140px); /* 距離領域を確保 */
    }
    #distance{
      font-size:1.125rem; /* 18px */
      color:var(--muted);
      flex:0 0 120px;     /* 固定幅で右揃え */
      text-align:right;
      white-space:nowrap;
    }

    #note{
      font-size:0.95rem;
      color:var(--muted);
      line-height:1.3;
      text-align:left;
      margin-top:4px;
    }

    button{
      align-self:flex-end;
      margin-top:6px;
      padding:12px 18px;
      border-radius:10px;
      border:0;
      background:var(--accent);
      color:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:1rem;
    }

    /* 小画面ではさらに幅を確保（左右フル幅利用） */
    @media (max-width:480px){
      html,body{padding:0}
      #wrap{width:100%;max-width:100%;padding:16px;border-radius:12px}
      #station{font-size:1.4rem; max-width: calc(100% - 120px);}
      #distance{flex:0 0 110px}
      button{width:100%}
    }
  </style>
</head>
<body>
  <div id="wrap" role="main" aria-live="polite">
    <div id="topRow">
      <div id="station">最寄り駅: 読み込み中…</div>
      <div id="distance" aria-hidden="true"></div>
    </div>
    <div id="note">stations.js を同フォルダに置いてください。自動で取得・再試行します。</div>
    <button id="retry" aria-label="再読み込みして最寄り駅を判定">再読み込みして判定</button>
  </div>

  <script>
    (function(){
      const elStation = document.getElementById('station');
      const elDistance = document.getElementById('distance');
      const elNote = document.getElementById('note');
      const btn = document.getElementById('retry');

      function toRad(d){ return d * Math.PI / 180; }
      function hav(lat1, lon1, lat2, lon2){
        const R = 6371000;
        const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      async function fetchAndEvalStations(token){
        const url = 'stations.js' + (token ? ('?v=' + encodeURIComponent(token)) : '');
        const res = await fetch(url, {cache: 'no-store'});
        if(!res.ok) throw new Error('stations.js の取得に失敗: ' + res.status);
        const text = await res.text();
        try {
          const fn = new Function('window', text + '\nreturn typeof window.stations !== "undefined" ? window.stations : null;');
          return fn(window);
        } catch(e){
          throw new Error('stations.js の評価に失敗: ' + e.message);
        }
      }

      function showNearestByCoords(lat, lon){
        if(!window.stations || !Array.isArray(window.stations) || window.stations.length === 0){
          elStation.textContent = 'データが見つかりません';
          elDistance.textContent = '';
          return;
        }
        const curLat = Number(lat), curLon = Number(lon);
        let best = null;
        for(const s of window.stations){
          const sLat = Number(s.lat), sLon = Number(s.lon);
          if(!isFinite(sLat) || !isFinite(sLon)) continue;
          const d = hav(curLat, curLon, sLat, sLon);
          if(!best || d < best.d) best = { name: s.name, d: Math.round(d) };
        }
        if(best){
          elStation.textContent = `${best.name}`;
          elDistance.textContent = `約 ${best.d} m`;
        } else {
          elStation.textContent = '最寄り判定に失敗しました';
          elDistance.textContent = '';
        }
      }

      let inProgress = false;
      async function runOnce(force){
        if(inProgress) return;
        inProgress = true;
        elStation.textContent = 'データを取得中…';
        elDistance.textContent = '';
        let loaded = false;
        for(let i=0;i<3;i++){
          try {
            const token = force ? Date.now() : (i === 0 ? '' : Date.now());
            const s = await fetchAndEvalStations(token);
            if(s && Array.isArray(s) && s.length > 0){ loaded = true; break; }
          } catch(e){
            elNote.textContent = '読み込み試行中: ' + e.message;
          }
          await new Promise(r => setTimeout(r, 300));
        }

        if(!loaded){
          elStation.textContent = 'stations.js が読み込めません';
          elDistance.textContent = '';
          elNote.textContent = 'stations.js を同フォルダに配置し、ファイル名が小文字 exactly stations.js であることを確認してください。';
          inProgress = false;
          return;
        }

        if(navigator.geolocation){
          elStation.textContent = '現在地を取得中…';
          navigator.geolocation.getCurrentPosition(p=>{
            showNearestByCoords(p.coords.latitude, p.coords.longitude);
            elNote.textContent = '';
            inProgress = false;
          }, err=>{
            elStation.textContent = '位置情報が取得できません';
            elDistance.textContent = '';
            elNote.textContent = '端末の位置情報許可を確認してください。手動テストは URL に ?lat=35.52231&lon=139.69254 を付けてください。';
            inProgress = false;
          }, { enableHighAccuracy: true, maximumAge:0, timeout:10000 });
        } else {
          elStation.textContent = '位置情報未対応';
          elDistance.textContent = '';
          const p = new URLSearchParams(location.search);
          const qlat = p.get('lat'), qlon = p.get('lon');
          if(qlat && qlon){ showNearestByCoords(Number(qlat), Number(qlon)); elNote.textContent = ''; }
          else { elNote.textContent = '手動で試すには URL に ?lat=緯度&lon=経度 を付けてください。'; }
          inProgress = false;
        }
      }

      btn.addEventListener('click', ()=>{ runOnce(true); });
      runOnce(false);
      window._showNearest = function(lat,lon){ showNearestByCoords(lat,lon); };
    })();
  </script>
</body>
</html>
