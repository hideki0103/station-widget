<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nearest Station</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;display:flex;align-items:center;justify-content:center;background:#ffffff;color:#111}
    #wrap{max-width:520px;width:90%;text-align:center;padding:20px;border-radius:8px}
    #station{font-size:20px;font-weight:700}
    #distance{margin-top:8px;font-size:16px;color:#444}
    .small{font-size:12px;color:#888;margin-top:10px}
  </style>
</head>
<body>
  <div id="wrap">
    <div id="station">最寄り駅: 読み込み中…</div>
    <div id="distance"></div>
    <div class="small" id="debug" aria-hidden="true"></div>
  </div>

  <script>
    // 最小ページ：stations.js を同じディレクトリに配置して読み込む想定
    // キャッシュ対策が必要なら URL に ?v= を付けて読み込んでください
    (function(){
      // ハーヴァーシン（メートル）
      function toRad(d){ return d * Math.PI / 180; }
      function hav(lat1, lon1, lat2, lon2){
        const R = 6371000;
        const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      // UI
      const elStation = document.getElementById('station');
      const elDistance = document.getElementById('distance');
      const elDebug = document.getElementById('debug');

      // 読み込み済みの stations がなければ動的読み込みを試みる
      function loadStations(src){
        return new Promise((resolve,reject)=>{
          if(window.stations && Array.isArray(window.stations)) return resolve(window.stations);
          const s = document.createElement('script');
          s.src = src || 'stations.js';
          s.onload = ()=>resolve(window.stations || null);
          s.onerror = ()=>reject(new Error('stations.js load failed'));
          document.head.appendChild(s);
        });
      }

      function showNearest(lat, lon){
        if(!window.stations || !Array.isArray(window.stations)){ elStation.textContent = 'データが見つかりません'; return; }
        const curLat = Number(lat), curLon = Number(lon);
        let best = null;
        for(const st of window.stations){
          const sLat = Number(st.lat), sLon = Number(st.lon);
          if(!isFinite(sLat) || !isFinite(sLon)) continue;
          const d = hav(curLat, curLon, sLat, sLon);
          if(!best || d < best.d) best = { name: st.name, d: Math.round(d) };
        }
        if(best){
          elStation.textContent = `最寄り駅: ${best.name}`;
          elDistance.textContent = `距離: 約 ${best.d} m`;
        } else {
          elStation.textContent = '最寄り駅が判定できません';
        }
      }

      // 位置取得と結果表示
      function determine(){
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(p=>{
            const lat = p.coords.latitude, lon = p.coords.longitude;
            showNearest(lat, lon);
            elDebug.textContent = `(${lat.toFixed(5)}, ${lon.toFixed(5)})`;
          }, err=>{
            elStation.textContent = '位置情報取得不可';
            elDistance.textContent = '';
            elDebug.textContent = err && err.message ? err.message : '位置情報エラー';
          }, { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
        } else {
          elStation.textContent = '位置情報未対応';
          elDistance.textContent = '';
        }
      }

      // 起動シーケンス：stations を読み込み → 位置判定
      loadStations().then(s=>{
        if(!s) elDebug.textContent = 'stations が未定義です';
        determine();
      }).catch(e=>{
        elStation.textContent = 'データ読み込み失敗';
        elDebug.textContent = e.message || 'stations.js 読み込み失敗';
      });

      // もし手動でテストしたい場合はコンソールから showNearest(lat,lon) を呼べます
      window.showNearest = showNearest;
    })();
  </script>
</body>
</html>
