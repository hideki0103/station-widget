<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nearest Station</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",sans-serif;background:#fff;color:#111;display:flex;align-items:center;justify-content:center}
    #wrap{width:92%;max-width:520px;padding:18px;border-radius:10px;text-align:center;border:1px solid #eee;background:#fafafa}
    #station{font-size:20px;font-weight:700}
    #distance{margin-top:8px;font-size:16px;color:#555}
    #note{margin-top:10px;font-size:12px;color:#888}
    button{margin-top:12px;padding:8px 12px;border-radius:8px;border:1px solid #d0d6e6;background:#2f63ff;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div id="wrap" role="main" aria-live="polite">
    <div id="station">最寄り駅: 読み込み中…</div>
    <div id="distance"></div>
    <div id="note">stations.js を同フォルダに置いてください。自動で読み込み・再試行します。</div>
    <button id="retry">再読み込みして判定</button>
  </div>

  <script>
    (function(){
      // ハーヴァーシン（メートル）
      function toRad(d){ return d * Math.PI / 180; }
      function hav(lat1, lon1, lat2, lon2){
        const R = 6371000;
        const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      const elStation = document.getElementById('station');
      const elDistance = document.getElementById('distance');
      const elNote = document.getElementById('note');
      const btn = document.getElementById('retry');

      // stations.js を確実に読み込むための関数
      function dynamicLoadStations(query){
        return new Promise((resolve,reject)=>{
          // 既に定義されている場合はそれを返す
          if(window.stations && Array.isArray(window.stations)){
            return resolve(window.stations);
          }
          const script = document.createElement('script');
          script.src = 'stations.js' + (query ? ('?v=' + encodeURIComponent(query)) : '');
          script.onload = function(){ return resolve(window.stations || null); };
          script.onerror = function(){ return reject(new Error('stations.js load error')); };
          document.head.appendChild(script);
        });
      }

      // 最寄り判定（stations が存在する前提）
      function showNearestByCoords(lat, lon){
        if(!window.stations || !Array.isArray(window.stations) || window.stations.length === 0){
          elStation.textContent = 'データが見つかりません';
          elDistance.textContent = '';
          return;
        }
        const curLat = Number(lat), curLon = Number(lon);
        let best = null;
        for(const s of window.stations){
          const sLat = Number(s.lat), sLon = Number(s.lon);
          if(!isFinite(sLat) || !isFinite(sLon)) continue;
          const d = hav(curLat, curLon, sLat, sLon);
          if(!best || d < best.d) best = { name: s.name, d: Math.round(d) };
        }
        if(best){
          elStation.textContent = `最寄り駅: ${best.name}`;
          elDistance.textContent = `距離: 約 ${best.d} m`;
        } else {
          elStation.textContent = '最寄り判定に失敗しました';
          elDistance.textContent = '';
        }
      }

      // 起動シーケンス: stations 読み込み→位置取得→表示
      async function runOnce(forceQuery){
        elStation.textContent = 'データ読み込み中…';
        elDistance.textContent = '';
        // 3回まで試行する
        let stationsLoaded = null;
        for(let i=0;i<3;i++){
          try {
            stationsLoaded = await dynamicLoadStations(forceQuery ? (Date.now()) : (i===0 ? '' : Date.now()));
            if(stationsLoaded && Array.isArray(stationsLoaded) && stationsLoaded.length>0) break;
          } catch(e) {
            // 続行してリトライ
          }
          await new Promise(r => setTimeout(r, 300)); // 小休止
        }
        if(!stationsLoaded || !Array.isArray(stationsLoaded) || stationsLoaded.length===0){
          // フォールバック: 既にページに stations がなければ一時的な最小配列を定義してお知らせ
          if(!window.stations || !Array.isArray(window.stations) || window.stations.length===0){
            window.stations = [
              { name: "八丁畷", lat: 35.52311, lon: 139.69150 },
              { name: "京急川崎", lat: 35.53099, lon: 139.70132 }
            ];
            elNote.textContent = '注意: stations.js が読み込めなかったため一時的なデータを使用しています。stations.js を配置して再読み込みしてください。';
          } else {
            elNote.textContent = 'stations.js を読み込みましたが中身が空です。stations.js を確認してください。';
          }
        } else {
          elNote.textContent = '';
        }

        // 位置取得を試みる（許可がなければ手動で console から showNearest を呼べるが
        // ユーザ要求でコンソールは使わせないため、Geolocation が不可なら固定メッセを出す）
        if(navigator.geolocation){
          elStation.textContent = '現在地を取得中…';
          navigator.geolocation.getCurrentPosition(p=>{
            showNearestByCoords(p.coords.latitude, p.coords.longitude);
          }, err=>{
            elStation.textContent = '位置情報が取得できません';
            elDistance.textContent = '';
            elNote.textContent += ' 端末の位置情報許可を確認してください。';
          }, { enableHighAccuracy: true, maximumAge:0, timeout:10000 });
        } else {
          elStation.textContent = '位置情報に未対応の環境です';
          elDistance.textContent = '';
          elNote.textContent += ' 手動で位置を渡す場合は URL に ?lat=緯度&lon=経度 を付けてください。';
          // URL クエリに座標があれば自動で判定
          const p = new URLSearchParams(location.search);
          const qlat = p.get('lat'), qlon = p.get('lon');
          if(qlat && qlon){
            showNearestByCoords(Number(qlat), Number(qlon));
          }
        }
      }

      // ボタンで強制再読み込み＋キャッシュ回避トークン
      btn.addEventListener('click', ()=>{
        try{ delete window.stations; }catch(e){}
        runOnce(true);
      });

      // 自動起動
      runOnce(false);

      // デバッグ要求の代替としてコンソールを使わずに外部から呼べる関数を公開
      window._showNearest = function(lat,lon){ showNearestByCoords(lat,lon); };
    })();
  </script>
</body>
</html>

